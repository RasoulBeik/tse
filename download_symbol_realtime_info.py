import symbol_repository as rep
from datetime import datetime
from pytse_client.symbols_data import get_ticker_index
from pytse_client import config, symbols_data, tse_settings, download_client_types_records, Ticker
import simple_request as sr
import globals
from time import sleep
import numpy as np


def download_realtime_demands(symbol_name, reload_period=3, max_reload=None):
    current_date = datetime.now().strftime('%Y%m%d')
    file_name = './trade_details/{}_{}_realtime.txt'.format(symbol_name,current_date)
    symbol_id = get_ticker_index(symbol_name)
    
    max_reload = np.inf if max_reload is None else max_reload
    reload_count = 0
    
    while reload_count < max_reload:
        current_time = datetime.now().strftime('%H:%M:%S')

        try:
            response = sr.simple_get(globals.SYMBOL_REALTIME_DEMANDS_URL.format(symbol_id))
            response = str(response)
        except:
            response = None

        if response is not None:
            with open(file_name, "a") as myfile:
                myfile.write(response)
                myfile.write("\n\n")

        reload_count = reload_count + 1
        print(reload_count, current_date, current_time)
        sleep(reload_period)
    return

if __name__ == "__main__":
    symbol_name = 'ذوب'
    download_realtime_demands(symbol_name)


# response message format : b'8 line ending with;'   or  b"8 line ending with;"

# line 1: ohlc data قبلا در آوردی

# line 2: اطلاعات شاخص کل
# 99/10/7 12:30:56,F,1419053.61,<div class='mn'>(4516.99)</div> -0.32%,56264396142211000,10467216593,128364138553945,2142634,P,3628161966,70474142633439,952513,P,913260,79783679012,6325,;
# date time, F, index, <div>index growth</div> index growth percent, market value, bourse volume , bourse value,  bourse count, P, Farabourse volume, Farabourse value, Farabouse count, P, moshtagheh volume, moshtagheh value, moshtagheh count,;

# line 3: orders قبلا در آوردی

# line 4: ???
# 98466,632545,387074;
# ?,?,?;

# line 5: اطلاعات حقیقی/حقوقی
# 73481142,55685844,0,113234416,15932570,8499,37,0,12046,20;
# ind_buy_vol, corp_buy_vol, 0, ind_sell_vol, corp_sell_vol, ind_buy_count, corp_buy_count, ind_sell_count, corp_sell_count;

# line 6: ohlc اطلاعات مربوط به گروه بانکی (30 شرکت)

# line 7: هیچی
# ;

# line 8: 0
# 0;

# Format No 1:
# ---------------------------------------------------------
# b'12:29:59,A ,13620,13500,13330,13560,13940,13170,25460,129166986,1744139993550,0,20201227,122959;
# ;
# 7@30721@13620@13620@20250@2,3@59842@13610@13700@123507@13,10@123308@13600@13710@53259@4,;
# 98466,632545,387074;
# 73481142,55685844,0,113234416,15932570,8499,37,0,12046,20;
# 44818950263583523@39210@39386@41273@28797@75434330@2971057196697,63917421733088077@3160@3190@3240@32816@631184667@2012155994410,778253364357513@4820@4840@4850@13324@185632043@898680306150,28320293733348826@3040@3030@3020@18446@335806690@1018711563060,33293588228706998@3930@3960@4120@17317@426059027@1688340981390,46830341954511303@21347@21690@21782@451@948495@20247522765,47302318535715632@5400@5440@5570@5514@86816045@472502147400,9536587154100457@12040@12000@11910@3947@37165384@446157510870,24644999329120295@17437@17781@17842@8956@161384880@2869562468076,22087269603540841@19030@18790@18640@3499@11637325@218667531710,41379697187196382@6591@6636@6865@2449@19805549@131423473911,45050389997905274@11050@10950@11220@3485@20934297@229173670510,43913530989262989@7677@7828@7828@0@0@0,7920014658832193@21596@21338@20967@348@2897278@62569615688,38179358042686391@12623@12731@13013@238@3326888@41995307224,47333458678352378@9660@9830@9950@924@5699615@55984409250,47996917271187218@4440@4520@4520@0@0@0,19954896371640204@12286@12297@12536@700@4556872@56037370802,20626178773287666@1000@1000@1000@0@0@0,49776615757150035@2088@2086@2086@0@0@0,23175320865252772@4429@4300@4300@0@0@0,41036181221659834@1000@1000@1000@0@0@0,7769065543658313@2716@2717@2717@0@0@0,7881099657101647@1000@1000@1000@0@0@0,20236748310756911@1000@1000@1000@0@0@0,49396161442874149@1000@1000@1000@0@0@0,71665987033532474@1000@1000@1000@0@0@0,70841787274602388@1000@1000@1000@0@0@0,57424362806755583@1000@1000@1000@0@0@0,34186024944625724@1213@2000@2000@0@0@0,;
# ;
# 0;
# '

# Format No 2:
# ------------------------------------------
# b"12:29:59,A ,13620,13500,13330,13560,13940,13170,25460,129166986,1744139993550,0,20201227,122959;
# 99/10/7 12:30:56,F,1419053.61,<div class='mn'>(4516.99)</div> -0.32%,56264396142211000,10467216593,128364138553945,2142634,P,3628161966,70474142633439,952513,P,913260,79783679012,6325,;
# 7@30721@13620@13620@20250@2,3@59842@13610@13700@118007@12,10@123308@13600@13710@53259@4,;
# 98466,632545,387074;
# 73481142,55685844,0,113234416,15932570,8499,37,0,12046,20;
# 44818950263583523@39210@39386@41273@28797@75434330@2971057196697,63917421733088077@3160@3190@3240@32816@631184667@2012155994410,778253364357513@4820@4840@4850@13324@185632043@898680306150,28320293733348826@3040@3030@3020@18446@335806690@1018711563060,33293588228706998@3930@3960@4120@17317@426059027@1688340981390,46830341954511303@21347@21690@21782@451@948495@20247522765,47302318535715632@5400@5440@5570@5514@86816045@472502147400,9536587154100457@12040@12000@11910@3947@37165384@446157510870,24644999329120295@17437@17781@17842@8956@161384880@2869562468076,22087269603540841@19030@18790@18640@3499@11637325@218667531710,41379697187196382@6591@6636@6865@2449@19805549@131423473911,45050389997905274@11050@10950@11220@3485@20934297@229173670510,43913530989262989@7677@7828@7828@0@0@0,7920014658832193@21596@21338@20967@348@2897278@62569615688,38179358042686391@12623@12731@13013@238@3326888@41995307224,47333458678352378@9660@9830@9950@924@5699615@55984409250,47996917271187218@4440@4520@4520@0@0@0,19954896371640204@12286@12297@12536@700@4556872@56037370802,20626178773287666@1000@1000@1000@0@0@0,49776615757150035@2088@2086@2086@0@0@0,23175320865252772@4429@4300@4300@0@0@0,41036181221659834@1000@1000@1000@0@0@0,7769065543658313@2716@2717@2717@0@0@0,7881099657101647@1000@1000@1000@0@0@0,20236748310756911@1000@1000@1000@0@0@0,49396161442874149@1000@1000@1000@0@0@0,71665987033532474@1000@1000@1000@0@0@0,70841787274602388@1000@1000@1000@0@0@0,57424362806755583@1000@1000@1000@0@0@0,34186024944625724@1213@2000@2000@0@0@0,;
# ;
# 0;
# "

# Format No 3:
# -----------------------------------------------------
# b"12:29:59,A ,13620,13500,13330,13560,13940,13170,25460,129166986,1744139993550,0,20201227,122959;
# 99/10/7 12:30:56,F,1419053.61,<div class='mn'>(4516.99)</div> -0.32%,56264396142211000,10467216593,128364138553945,2142634,P,3628161966,70474142633439,952513,P,913260,79783679012,6325,;
# 7@30721@13620@13620@20250@2,3@59842@13610@13700@118007@12,10@123308@13600@13710@53259@4,;
# 98466,632546,387074;
# 73481142,55685844,0,113234416,15932570,8499,37,0,12046,20;
# ;
# ;
# 0;
# "
